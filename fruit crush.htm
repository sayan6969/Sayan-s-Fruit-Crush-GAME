<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sayan's Fruit Crush - Fixed Pro</title>
    <style>
        :root {
            --bg: #050510;
            --accent: #00ffcc;
            --tile-size: 11vw; 
            --max-tile: 65px;
        }
        @media (min-width: 600px) { :root { --tile-size: var(--max-tile); } }

        * { box-sizing: border-box; touch-action: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg);
            color: white;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        /* Splash Screen */
        #splash {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle, #1a1a2e, #050510);
            z-index: 999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .title { font-size: clamp(30px, 10vw, 60px); font-weight: 900; color: var(--accent); }
        .title span { display: inline-block; animation: bounce 1.5s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); color: #ff00ff; } }

        /* Game UI */
        .hud {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 500px;
            padding: 15px;
            background: rgba(22, 33, 62, 0.9);
            border-bottom: 2px solid var(--accent);
            font-weight: bold;
        }

        #grid-container { flex-grow: 1; display: flex; align-items: center; justify-content: center; width: 100%; }

        #grid {
            display: grid;
            grid-template-columns: repeat(8, min(var(--tile-size), var(--max-tile)));
            grid-template-rows: repeat(8, min(var(--tile-size), var(--max-tile)));
            gap: 4px;
            padding: 8px;
            background: #0f3460;
            border-radius: 12px;
            position: relative;
        }

        .tile {
            width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            display: flex;
            align-items: center; justify-content: center;
        }

        .fruit {
            font-size: clamp(24px, 7vw, 40px);
            cursor: pointer;
            z-index: 2;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* BLAST EFFECT */
        .blast-anim { animation: blast 0.4s ease-out forwards; }
        @keyframes blast {
            0% { transform: scale(1); filter: brightness(2); }
            100% { transform: scale(1.8); opacity: 0; }
        }

        .bomb-bg { background: radial-gradient(circle, #ff0055, transparent); border-radius: 50%; box-shadow: 0 0 10px #ff0055; }
        .black-bomb-bg { background: #fff; border-radius: 50%; box-shadow: 0 0 15px #fff; }

        .watermark { padding: 10px; font-size: 12px; font-weight: bold; color: var(--accent); animation: float 3s infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        #game-over {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100;
        }
    </style>
</head>
<body>

    <!-- AUDIO -->
    <audio id="bgMusic" loop preload="auto">
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3" type="audio/mpeg">
    </audio>
    <audio id="crushSfx" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3" type="audio/mpeg">
    </audio>

    <div id="splash" onclick="startGame()">
        <div class="title">
            <span>S</span><span>a</span><span>y</span><span>a</span><span>n</span><span>'</span><span>s</span><br>
            <span>F</span><span>r</span><span>u</span><span>i</span><span>t</span>
            <span>C</span><span>r</span><span>u</span><span>s</span><span>h</span>
        </div>
        <p style="color: #aaa; margin-top: 20px;">TOUCH TO PLAY</p>
    </div>

    <div class="hud">
        <div>LVL: <span id="lvl">1</span></div>
        <div>ü™ô <span id="coins">0</span></div>
        <div style="color:#ff4d4d">‚è≥ <span id="timer">02:00</span></div>
    </div>

    <div id="grid-container">
        <div id="grid"></div>
    </div>

    <div class="watermark">DEVELOPED BY SAYAN DAS (A.I. DEVELOPER)</div>

    <div id="game-over">
        <h1 style="color:var(--accent)">TIME'S UP!</h1>
        <p id="final-stats"></p>
        <button onclick="location.reload()" style="padding:15px 40px; border:none; background:var(--accent); font-weight:bold; border-radius:30px; cursor:pointer;">NEXT LEVEL</button>
    </div>

    <script>
        const gridEl = document.getElementById('grid');
        const crushSfx = document.getElementById('crushSfx');
        const bgMusic = document.getElementById('bgMusic');
        const fruits = ['üçé', 'üçá', 'üçä', 'üçç', 'üçã', 'üçâ'];
        
        let squares = [];
        let gameActive = false;
        let isMoving = false;
        let userData = JSON.parse(localStorage.getItem("sayan_crush_final")) || { level: 1, coins: 0 };

        function startGame() {
            bgMusic.volume = 0.3;
            bgMusic.play().catch(() => {});
            document.getElementById('splash').style.display = 'none';
            initBoard();
        }

        function initBoard() {
            document.getElementById('lvl').innerText = userData.level;
            document.getElementById('coins').innerText = userData.coins;
            
            for (let i = 0; i < 64; i++) {
                const tile = document.createElement('div');
                tile.className = 'tile';
                tile.id = i;
                
                const span = document.createElement('span');
                span.className = 'fruit';
                span.innerHTML = fruits[Math.floor(Math.random() * fruits.length)];
                span.draggable = true;
                
                tile.appendChild(span);
                gridEl.appendChild(tile);
                squares.push(tile);

                // Events
                span.addEventListener('mousedown', dragStart);
                span.addEventListener('touchstart', dragStart, {passive: true});
                span.addEventListener('dragover', e => e.preventDefault());
                span.addEventListener('drop', dragDrop);
            }
            gameActive = true;
            runTimer();
            // Start the logic loop
            setInterval(gameLogic, 200);
        }

        function playCrushSfx() {
            const sound = crushSfx.cloneNode();
            sound.volume = 0.5;
            sound.play();
        }

        let idDragged, idReplaced;

        function dragStart(e) {
            if (!gameActive || isMoving) return;
            idDragged = parseInt(this.parentElement.id);
        }

        async function dragDrop(e) {
            idReplaced = parseInt(this.parentElement.id);
            const valid = [idDragged - 1, idDragged + 1, idDragged - 8, idDragged + 8].includes(idReplaced);
            
            if (valid) {
                isMoving = true;
                await swap(idDragged, idReplaced);
                // Check if move resulted in a match, if not, swap back
                if (!checkMatches()) {
                    setTimeout(() => swap(idDragged, idReplaced), 300);
                }
                isMoving = false;
            }
        }

        async function swap(i1, i2) {
            const f1 = squares[i1].querySelector('.fruit');
            const f2 = squares[i2].querySelector('.fruit');

            // Animation
            const r1 = f1.getBoundingClientRect();
            const r2 = f2.getBoundingClientRect();
            f1.style.transform = `translate(${r2.left - r1.left}px, ${r2.top - r1.top}px)`;
            f2.style.transform = `translate(${r1.left - r2.left}px, ${r1.top - r2.top}px)`;

            await new Promise(r => setTimeout(r, 250));

            // Data Swap
            let v1 = f1.innerHTML, v2 = f2.innerHTML;
            if (v1 === 'üñ§' || v2 === 'üñ§') {
                blastColor((v1 === 'üñ§') ? v2 : v1);
                f1.innerHTML = ''; f2.innerHTML = '';
            } else {
                f1.innerHTML = v2; f2.innerHTML = v1;
            }

            f1.style.transform = f2.style.transform = '';
        }

        function blastColor(color) {
            playCrushSfx();
            squares.forEach(s => {
                const f = s.querySelector('.fruit');
                if (f.innerHTML === color) {
                    f.classList.add('blast-anim');
                    userData.coins += 5;
                    setTimeout(() => f.innerHTML = '', 400);
                }
            });
            save();
        }

        function gameLogic() {
            if (!gameActive || isMoving) return;
            checkMatches();
            applyGravity();
            updateSpecials();
        }

        function checkMatches() {
            let found = false;
            // Rows
            for (let i = 0; i < 64; i++) {
                if (i % 8 < 6) {
                    let r3 = [i, i+1, i+2];
                    let val = squares[i].querySelector('.fruit').innerHTML;
                    if (val && !['üí£','üñ§'].includes(val) && r3.every(x => squares[x].querySelector('.fruit').innerHTML === val)) {
                        // Check for 4 or 5
                        let reward = null;
                        if (i % 8 < 4 && squares[i+3].querySelector('.fruit').innerHTML === val) {
                            r3.push(i+3); reward = 'üí£';
                            if (i % 8 < 3 && squares[i+4].querySelector('.fruit').innerHTML === val) {
                                r3.push(i+4); reward = 'üñ§';
                            }
                        }
                        blastTiles(r3, reward);
                        found = true;
                    }
                }
            }
            // Columns
            for (let i = 0; i < 48; i++) {
                let c3 = [i, i+8, i+16];
                let val = squares[i].querySelector('.fruit').innerHTML;
                if (val && !['üí£','üñ§'].includes(val) && c3.every(x => squares[x].querySelector('.fruit').innerHTML === val)) {
                    let reward = null;
                    if (i < 40 && squares[i+24].querySelector('.fruit').innerHTML === val) {
                        c3.push(i+24); reward = 'üí£';
                        if (i < 32 && squares[i+32].querySelector('.fruit').innerHTML === val) {
                            c3.push(i+32); reward = 'üñ§';
                        }
                    }
                    blastTiles(c3, reward);
                    found = true;
                }
            }
            return found;
        }

        function blastTiles(arr, reward) {
            playCrushSfx();
            arr.forEach((idx, k) => {
                const f = squares[idx].querySelector('.fruit');
                if (f.innerHTML !== '') {
                    f.classList.add('blast-anim');
                    setTimeout(() => {
                        f.innerHTML = (k === 0 && reward) ? reward : '';
                        f.classList.remove('blast-anim');
                    }, 400);
                }
            });
            userData.coins += arr.length * 10;
            save();
        }

        function applyGravity() {
            for (let i = 55; i >= 0; i--) {
                const cur = squares[i].querySelector('.fruit');
                const bel = squares[i+8].querySelector('.fruit');
                if (cur.innerHTML !== '' && bel.innerHTML === '') {
                    bel.innerHTML = cur.innerHTML;
                    cur.innerHTML = '';
                }
            }
            for (let i = 0; i < 8; i++) {
                const f = squares[i].querySelector('.fruit');
                if (f.innerHTML === '') f.innerHTML = fruits[Math.floor(Math.random() * fruits.length)];
            }
        }

        function updateSpecials() {
            squares.forEach(s => {
                const f = s.querySelector('.fruit');
                s.classList.toggle('bomb-bg', f.innerHTML === 'üí£');
                s.classList.toggle('black-bomb-bg', f.innerHTML === 'üñ§');
            });
        }

        function runTimer() {
            let time = 120;
            const tObj = setInterval(() => {
                time--;
                document.getElementById('timer').innerText = `${Math.floor(time/60)}:${(time%60).toString().padStart(2,'0')}`;
                if (time <= 0) {
                    clearInterval(tObj);
                    gameActive = false;
                    userData.level++;
                    save();
                    bgMusic.pause();
                    document.getElementById('game-over').style.display = 'flex';
                    document.getElementById('final-stats').innerText = `Level Finished! Total Coins: ${userData.coins}`;
                }
            }, 1000);
        }

        function save() {
            document.getElementById('coins').innerText = userData.coins;
            localStorage.setItem("sayan_crush_final", JSON.stringify(userData));
        }
    </script>
</body>
</html>