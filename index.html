<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sayan's Fruit Crush - Universal Touch</title>
    <style>
        :root {
            --bg: #050510;
            --accent: #00ffcc;
            --tile-size: 11vw; 
            --max-tile: 60px;
        }
        @media (min-width: 600px) { :root { --tile-size: var(--max-tile); } }

        * { 
            box-sizing: border-box; 
            touch-action: none; /* Critical: prevents screen scrolling while playing */
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg);
            color: white;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        #splash {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle, #1a1a2e, #050510);
            z-index: 999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .title { font-size: clamp(30px, 10vw, 60px); font-weight: 900; color: var(--accent); }
        .title span { display: inline-block; animation: bounce 1.5s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); color: #ff00ff; } }

        .hud {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 500px;
            padding: 15px;
            background: rgba(22, 33, 62, 0.9);
            border-bottom: 2px solid var(--accent);
            font-weight: bold;
        }

        #grid-container { flex-grow: 1; display: flex; align-items: center; justify-content: center; width: 100%; }

        #grid {
            display: grid;
            grid-template-columns: repeat(8, min(var(--tile-size), var(--max-tile)));
            grid-template-rows: repeat(8, min(var(--tile-size), var(--max-tile)));
            gap: 4px;
            padding: 8px;
            background: #0f3460;
            border-radius: 12px;
            position: relative;
        }

        .tile {
            width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            display: flex;
            align-items: center; justify-content: center;
            position: relative;
        }

        .fruit {
            font-size: clamp(24px, 7vw, 38px);
            z-index: 2;
            pointer-events: none; /* Allows the tile to catch the touch start */
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .falling { animation: slideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 1.4); }
        @keyframes slideIn { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .blast-anim { animation: blast 0.4s ease-out forwards; }
        @keyframes blast { 0% { transform: scale(1); filter: brightness(2); } 100% { transform: scale(1.8); opacity: 0; } }

        .bomb-bg { background: radial-gradient(circle, #ff0055, transparent); border-radius: 50%; box-shadow: 0 0 10px #ff0055; }
        .black-bomb-bg { background: #fff; border-radius: 50%; box-shadow: 0 0 15px #fff; }

        .watermark { padding: 10px; font-size: 12px; font-weight: bold; color: var(--accent); animation: float 3s infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        #game-over {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100;
        }
    </style>
</head>
<body>

    <!-- AUDIO -->
    <audio id="bgMusic" loop preload="auto">
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3" type="audio/mpeg">
    </audio>
    <audio id="crushSfx" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3" type="audio/mpeg">
    </audio>

    <div id="splash" onclick="startGame()">
        <div class="title">
            <span>S</span><span>a</span><span>y</span><span>a</span><span>n</span><span>'</span><span>s</span><br>
            <span>F</span><span>r</span><span>u</span><span>i</span><span>t</span>
            <span>C</span><span>r</span><span>u</span><span>s</span><span>h</span>
        </div>
        <p style="color: #00ffcc; margin-top: 20px; font-weight: bold; letter-spacing: 2px;">SWIPE TO CRUSH</p>
    </div>

    <div class="hud">
        <div>LVL: <span id="lvl">1</span></div>
        <div>ü™ô <span id="coins">0</span></div>
        <div style="color:#ff4d4d">‚è≥ <span id="timer">02:00</span></div>
    </div>

    <div id="grid-container">
        <div id="grid"></div>
    </div>

    <div class="watermark">DEVELOPED BY SAYAN DAS (A.I. DEVELOPER)</div>

    <div id="game-over">
        <h1 style="color:var(--accent)">TIME'S UP!</h1>
        <p id="final-stats" style="font-size: 20px;"></p>
        <button onclick="location.reload()" style="padding:15px 40px; border:none; background:var(--accent); font-weight:bold; border-radius:30px; cursor:pointer;">PLAY AGAIN</button>
    </div>

    <script>
        const gridEl = document.getElementById('grid');
        const crushSfx = document.getElementById('crushSfx');
        const bgMusic = document.getElementById('bgMusic');
        const fruits = ['üçé', 'üçá', 'üçä', 'üçç', 'üçã', 'üçâ'];
        
        let squares = [];
        let gameActive = false;
        let isProcessing = false;
        let userData = JSON.parse(localStorage.getItem("sayan_crush_v3")) || { level: 1, coins: 0 };

        // Interaction Variables
        let startX, startY, idDragged;

        function startGame() {
            bgMusic.volume = 0.3;
            bgMusic.play().catch(() => {});
            document.getElementById('splash').style.display = 'none';
            initBoard();
        }

        function initBoard() {
            document.getElementById('lvl').innerText = userData.level;
            document.getElementById('coins').innerText = userData.coins;
            
            for (let i = 0; i < 64; i++) {
                const tile = document.createElement('div');
                tile.className = 'tile';
                tile.id = i;
                
                const span = document.createElement('span');
                span.className = 'fruit';
                span.innerHTML = fruits[Math.floor(Math.random() * fruits.length)];
                
                tile.appendChild(span);
                gridEl.appendChild(tile);
                squares.push(tile);

                // Universal Touch/Mouse Events
                tile.addEventListener('pointerdown', touchStart);
                tile.addEventListener('pointerup', touchEnd);
            }
            gameActive = true;
            runTimer();
            setInterval(loop, 200);
        }

        function touchStart(e) {
            if (!gameActive || isProcessing) return;
            startX = e.clientX || e.touches[0].clientX;
            startY = e.clientY || e.touches[0].clientY;
            idDragged = parseInt(this.id);
        }

        function touchEnd(e) {
            if (idDragged === undefined || isProcessing) return;
            let endX = e.clientX || e.changedTouches[0].clientX;
            let endY = e.clientY || e.changedTouches[0].clientY;

            let diffX = endX - startX;
            let diffY = endY - startY;
            let threshold = 30; // Minimum swipe distance

            let idTarget = null;

            if (Math.abs(diffX) > Math.abs(diffY)) {
                // Horizontal Swipe
                if (diffX > threshold && idDragged % 8 !== 7) idTarget = idDragged + 1;
                else if (diffX < -threshold && idDragged % 8 !== 0) idTarget = idDragged - 1;
            } else {
                // Vertical Swipe
                if (diffY > threshold && idDragged < 56) idTarget = idDragged + 8;
                else if (diffY < -threshold && idDragged >= 8) idTarget = idDragged - 8;
            }

            if (idTarget !== null) handleMove(idDragged, idTarget);
            idDragged = undefined;
        }

        async function handleMove(i1, i2) {
            isProcessing = true;
            await swap(i1, i2);
            
            let matchFound = checkMatches();
            if (!matchFound) {
                // Swap back if no match (standard Candy Crush rule)
                setTimeout(() => swap(i1, i2), 250);
                setTimeout(() => { isProcessing = false; }, 500);
            } else {
                isProcessing = false;
            }
        }

        async function swap(i1, i2) {
            const f1 = squares[i1].querySelector('.fruit');
            const f2 = squares[i2].querySelector('.fruit');

            const r1 = f1.getBoundingClientRect();
            const r2 = f2.getBoundingClientRect();
            f1.style.transform = `translate(${r2.left - r1.left}px, ${r2.top - r1.top}px)`;
            f2.style.transform = `translate(${r1.left - r2.left}px, ${r1.top - r2.top}px)`;

            await new Promise(r => setTimeout(r, 250));

            let v1 = f1.innerHTML, v2 = f2.innerHTML;
            
            // Black Bomb Logic
            if (v1 === 'üñ§' || v2 === 'üñ§') {
                blastColor((v1 === 'üñ§') ? v2 : v1);
                f1.innerHTML = ''; f2.innerHTML = '';
            } else {
                f1.innerHTML = v2; f2.innerHTML = v1;
            }

            f1.style.transform = f2.style.transform = '';
        }

        function blastColor(color) {
            playSfx();
            squares.forEach(s => {
                const f = s.querySelector('.fruit');
                if (f.innerHTML === color) {
                    f.classList.add('blast-anim');
                    userData.coins += 5;
                    setTimeout(() => f.innerHTML = '', 400);
                }
            });
            save();
        }

        function loop() {
            if (!gameActive || isProcessing) return;
            checkMatches();
            applyGravity();
            updateSpecials();
        }

        function checkMatches() {
            let found = false;
            // Check rows and columns
            for (let i = 0; i < 64; i++) {
                let val = squares[i].querySelector('.fruit').innerHTML;
                if (!val || val === 'üí£' || val === 'üñ§') continue;

                // Horizontal
                if (i % 8 < 6) {
                    let r3 = [i, i+1, i+2];
                    if (r3.every(x => squares[x].querySelector('.fruit').innerHTML === val)) {
                        let reward = null;
                        if (i % 8 < 5 && squares[i+3].querySelector('.fruit').innerHTML === val) {
                            r3.push(i+3); reward = 'üí£';
                            if (i % 8 < 4 && squares[i+4].querySelector('.fruit').innerHTML === val) {
                                r3.push(i+4); reward = 'üñ§';
                            }
                        }
                        blastTiles(r3, reward);
                        found = true;
                    }
                }
                // Vertical
                if (i < 48) {
                    let c3 = [i, i+8, i+16];
                    if (c3.every(x => squares[x].querySelector('.fruit').innerHTML === val)) {
                        let reward = null;
                        if (i < 40 && squares[i+24].querySelector('.fruit').innerHTML === val) {
                            c3.push(i+24); reward = 'üí£';
                            if (i < 32 && squares[i+32].querySelector('.fruit').innerHTML === val) {
                                c3.push(i+32); reward = 'üñ§';
                            }
                        }
                        blastTiles(c3, reward);
                        found = true;
                    }
                }
            }
            return found;
        }

        function blastTiles(arr, reward) {
            playSfx();
            arr.forEach((idx, k) => {
                const f = squares[idx].querySelector('.fruit');
                if (f.innerHTML !== '') {
                    f.classList.add('blast-anim');
                    setTimeout(() => {
                        f.innerHTML = (k === 0 && reward) ? reward : '';
                        f.classList.remove('blast-anim');
                    }, 400);
                }
            });
            userData.coins += arr.length * 10;
            save();
        }

        function applyGravity() {
            for (let i = 55; i >= 0; i--) {
                const cur = squares[i].querySelector('.fruit');
                const bel = squares[i+8].querySelector('.fruit');
                if (cur.innerHTML !== '' && bel.innerHTML === '') {
                    bel.innerHTML = cur.innerHTML;
                    cur.innerHTML = '';
                    bel.classList.add('falling');
                    setTimeout(() => bel.classList.remove('falling'), 400);
                }
            }
            for (let i = 0; i < 8; i++) {
                const f = squares[i].querySelector('.fruit');
                if (f.innerHTML === '') {
                    f.innerHTML = fruits[Math.floor(Math.random() * fruits.length)];
                    f.classList.add('falling');
                    setTimeout(() => f.classList.remove('falling'), 400);
                }
            }
        }

        function updateSpecials() {
            squares.forEach(s => {
                const f = s.querySelector('.fruit');
                s.classList.toggle('bomb-bg', f.innerHTML === 'üí£');
                s.classList.toggle('black-bomb-bg', f.innerHTML === 'üñ§');
            });
        }

        function playSfx() {
            const sound = crushSfx.cloneNode();
            sound.volume = 0.5;
            sound.play();
        }

        function runTimer() {
            let time = 120;
            const timerObj = setInterval(() => {
                time--;
                document.getElementById('timer').innerText = `${Math.floor(time/60)}:${(time%60).toString().padStart(2,'0')}`;
                if (time <= 0) {
                    clearInterval(timerObj);
                    gameActive = false;
                    userData.level++;
                    save();
                    bgMusic.pause();
                    document.getElementById('game-over').style.display = 'flex';
                    document.getElementById('final-stats').innerText = `Coins Collected: ${userData.coins}`;
                }
            }, 1000);
        }

        function save() {
            document.getElementById('coins').innerText = userData.coins;
            localStorage.setItem("sayan_crush_v3", JSON.stringify(userData));
        }
    </script>
</body>
</html>